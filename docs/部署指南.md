# 部署指南

## 开发环境部署

### 前置条件
- Docker 和 Docker Compose
- Node.js 18+
- Git

### 快速启动

1. 克隆项目
```bash
git clone <repository-url>
cd zap
```

2. 启动基础服务
```bash
docker-compose up -d postgres redis
```

3. 安装依赖
```bash
cd frontend && npm install
cd ../backend && npm install
```

4. 初始化数据库
```bash
cd backend && npx prisma db push    # 应用数据库架构
cd backend && npm run db:seed       # 创建默认管理员用户
```

5. 启动应用
```bash
# 后端
cd backend && npm run start:dev

# 前端 (新终端)
cd frontend && npm run dev
```

## 生产环境部署

### 使用Docker Compose

1. 构建应用
```bash
# 构建前端
cd frontend && npm run build

# 构建后端
cd backend && npm run build
```

2. 启动所有服务
```bash
docker-compose up -d
```

### 使用Nginx反向代理

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 前端
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 后端API
    location /api {
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## 环境变量配置

### 后端环境变量
```bash
# 数据库配置
DATABASE_URL=postgresql://username:password@localhost:5432/zapdb

# JWT配置
JWT_SECRET=your-secret-key-here

# Redis配置
REDIS_URL=redis://localhost:6379

# 应用配置
NODE_ENV=production
PORT=3001
```

### 前端环境变量
```bash
# API地址
VITE_API_URL=https://your-domain.com/api

# 应用配置
VITE_APP_TITLE=零代码开发平台
```

## 数据库管理

### 数据库初始化
```bash
cd backend
npx prisma db push              # 推送架构到数据库
npm run db:seed                 # 创建默认管理员用户 (admin@zap.com / admin123)
```

### 运行迁移
```bash
cd backend
npx prisma migrate dev          # 开发环境迁移
npx prisma migrate deploy       # 生产环境迁移
```

### 生成客户端
```bash
cd backend
npx prisma generate
```

### 查看数据库
```bash
cd backend
npx prisma studio               # 打开数据库管理界面
```

## 监控和日志

### 应用监控
- 使用PM2管理进程
- 配置日志收集
- 设置性能监控

### 日志配置
```javascript
// 后端日志配置
const logger = require('winston');

logger.configure({
  level: 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' })
  ]
});
```

## 备份和恢复

### 数据库备份
```bash
# 创建备份
pg_dump zapdb > backup.sql

# 恢复备份
psql zapdb < backup.sql
```

### 文件备份
```bash
# 备份上传文件
tar -czf uploads_backup.tar.gz uploads/
```

## 安全配置

### HTTPS配置
```nginx
server {
    listen 443 ssl;
    server_name your-domain.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # 其他配置...
}
```

### 防火墙配置
```bash
# 开放必要端口
ufw allow 22    # SSH
ufw allow 80    # HTTP
ufw allow 443   # HTTPS
ufw allow 3000  # 前端
ufw allow 3001  # 后端
```

## 故障排除

### 常见问题

1. **数据库连接失败**
   - 检查PostgreSQL服务状态
   - 验证数据库连接字符串
   - 确认数据库用户权限

2. **Redis连接失败**
   - 检查Redis服务状态
   - 验证Redis连接字符串

3. **前端构建失败**
   - 检查Node.js版本
   - 清理node_modules重新安装
   - 检查TypeScript配置

4. **后端启动失败**
   - 检查端口占用
   - 验证环境变量配置
   - 查看错误日志

### 日志查看
```bash
# 查看Docker容器日志
docker-compose logs -f backend
docker-compose logs -f frontend

# 查看系统日志
journalctl -u docker
```